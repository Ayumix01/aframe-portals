!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){!function(e){function t(n){if(i[n])return i[n].exports;var r=i[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var i={};t.m=e,t.c=i,t.p="",t(0)}([function(e,t){if("undefined"==typeof AFRAME)throw new Error("Component attempted to register before AFRAME was available.");var i={childList:!0,attributes:!0,subtree:!0};AFRAME.registerComponent("aabb-collider",{schema:{collideNonVisible:{default:!1},debug:{default:!1},enabled:{default:!0},interval:{default:80},objects:{default:""}},init:function(){this.centerDifferenceVec3=new THREE.Vector3,this.clearedIntersectedEls=[],this.closestIntersectedEl=null,this.boundingBox=new THREE.Box3,this.boxCenter=new THREE.Vector3,this.boxHelper=new THREE.BoxHelper,this.boxMax=new THREE.Vector3,this.boxMin=new THREE.Vector3,this.hitClosestClearEventDetail={},this.hitClosestEventDetail={},this.intersectedEls=[],this.objectEls=[],this.newIntersectedEls=[],this.prevCheckTime=void 0,this.previousIntersectedEls=[],this.setDirty=this.setDirty.bind(this),this.observer=new MutationObserver(this.setDirty),this.dirty=!0,this.hitStartEventDetail={intersectedEls:this.newIntersectedEls}},play:function(){this.observer.observe(this.el.sceneEl,i),this.el.sceneEl.addEventListener("object3dset",this.setDirty),this.el.sceneEl.addEventListener("object3dremove",this.setDirty)},remove:function(){this.observer.disconnect(),this.el.sceneEl.removeEventListener("object3dset",this.setDirty),this.el.sceneEl.removeEventListener("object3dremove",this.setDirty)},tick:function(e){var t,i,n,r,s=this.boundingBox,o=this.centerDifferenceVec3,l=this.clearedIntersectedEls,c=this.intersectedEls,a=this.el,h=this.newIntersectedEls,d=this.objectEls,E=this.prevCheckTime,b=this.previousIntersectedEls;if(this.data.enabled&&!(E&&e-E<this.data.interval)){for(this.prevCheckTime=e,this.dirty&&this.refreshObjects(),s.setFromObject(a.object3D),this.boxMin.copy(s.min),this.boxMax.copy(s.max),s.getCenter(this.boxCenter),this.data.debug&&(this.boxHelper.setFromObject(a.object3D),this.boxHelper.parent||a.sceneEl.object3D.add(this.boxHelper)),function(e,t){var i;for(e.length=0,i=0;i<t.length;i++)e[i]=t[i]}(b,c),c.length=0,r=0;r<d.length;r++)d[r]!==this.el&&(this.data.collideNonVisible||d[r].getAttribute("visible")?this.isIntersecting(d[r])&&c.push(d[r]):this.data.debug&&(t=d[r].object3D.boxHelper)&&(a.sceneEl.object3D.remove(t),d[r].object3D.boxHelper=null));for(h.length=0,r=0;r<c.length;r++)-1===b.indexOf(c[r])&&h.push(c[r]);for(l.length=0,r=0;r<b.length;r++)-1===c.indexOf(b[r])&&(b[r].hasAttribute("aabb-collider")||b[r].emit("hitend"),l.push(b[r]));for(r=0;r<h.length;r++)h[r]!==this.el&&(h[r].hasAttribute("aabb-collider")||h[r].emit("hitstart"));for(r=0;r<c.length;r++)c[r]!==this.el&&(o.copy(c[r].object3D.boundingBoxCenter).sub(this.boxCenter),(void 0===i||o.length()<i)&&(i=o.length(),n=c[r]));!c.length&&this.closestIntersectedEl?(this.hitClosestClearEventDetail.el=this.closestIntersectedEl,this.closestIntersectedEl.emit("hitclosestclear"),this.closestIntersectedEl=null,a.emit("hitclosestclear",this.hitClosestClearEventDetail)):n!==this.closestIntersectedEl&&(this.closestIntersectedEl&&(this.hitClosestClearEventDetail.el=this.closestIntersectedEl,this.closestIntersectedEl.emit("hitclosestclear",this.hitClosestClearEventDetail)),n&&(n.emit("hitclosest"),this.closestIntersectedEl=n,this.hitClosestEventDetail.el=n,a.emit("hitclosest",this.hitClosestEventDetail))),l.length&&a.emit("hitend"),h.length&&a.emit("hitstart",this.hitStartEventDetail)}},isIntersecting:function(){var e=new THREE.Box3;return function(t){var i,n;return e.setFromObject(t.object3D),this.data.debug&&(t.object3D.boxHelper||(t.object3D.boxHelper=new THREE.BoxHelper(t.object3D,new THREE.Color(Math.random(),Math.random(),Math.random())),t.sceneEl.object3D.add(t.object3D.boxHelper)),t.object3D.boxHelper.setFromObject(t.object3D)),i=e.min,n=e.max,t.object3D.boundingBoxCenter=t.object3D.boundingBoxCenter||new THREE.Vector3,e.getCenter(t.object3D.boundingBoxCenter),this.boxMin.x<=n.x&&this.boxMax.x>=i.x&&this.boxMin.y<=n.y&&this.boxMax.y>=i.y&&this.boxMin.z<=n.z&&this.boxMax.z>=i.z}}(),setDirty:function(){this.dirty=!0},refreshObjects:function(){var e=this.data;this.objectEls=e.objects?this.el.sceneEl.querySelectorAll(e.objects):this.el.sceneEl.children,this.dirty=!1}})}]),AFRAME.registerComponent("portal",{schema:{destSelector:{default:""},width:{default:2},height:{default:3},maxRecursion:{default:2}},init:function(){var e=this.el,t=e.sceneEl,i=this.data;e.justTeleported=!1;var n=new THREE.BoxBufferGeometry(i.width,i.height,.01),r=new THREE.MeshBasicMaterial({colorWrite:!1}),s=new THREE.Mesh(n,r);s.geometry.computeBoundingSphere(),s.frustumCulled=!0,s.matrixAutoUpdate=!1,s.renderOrder=2,s.visible=!0,e.object3D.add(s),t.addEventListener("loaded",function(){var i=t.camera.el;i.id||(i.id="web-portal-cam-tag"),e.setAttribute("aabb-collider",{objects:"#"+i.id})}),t.addEventListener("portal-teleported",function(){e.justTeleported=!0}),e.addEventListener("hitstart",function(){if(!0!==e.justTeleported){t.emit("portal-teleported");var n=t.camera,r=n.el,s=document.querySelector(i.destSelector).object3D,o=e.object3D.rotation,l=s.rotation,c=new THREE.Euler(o.x-l.x,o.y-l.y,o.z-l.z);r.components["look-controls"]&&(r.components["look-controls"].yawObject.rotation.y+=c.y);var a=new THREE.Vector3;a.subVectors(n.getWorldPosition(new THREE.Vector3),e.object3D.getWorldPosition(new THREE.Vector3)),console.log(a);var h=s.position.clone().add(a);n.el.object3D.position.x=h.x,n.el.object3D.position.y=h.y,n.el.object3D.position.z=h.z}}),t.portals||(t.portals=[],t.portalPairs=[]);var o=t.portalPairs;t.portals.push(e.object3D);var l=document.querySelector(i.destSelector);if(l){var c=!1;o.forEach(function(t){t.forEach(function(t){t==e.object3D&&(c=!0)})}),0==c&&o.push([e.object3D,l.object3D])}},tick:function(){var e=this.el;!0===e.justTeleported&&setTimeout(function(){e.justTeleported=!1},100)},tock:function(){var e=this.el.sceneEl;this.renderRecursivePortals(e.renderer,e.camera,0)},renderRecursivePortals:function(e,t,i){var n=this,r=this.el.sceneEl,s=r.portals,o=r.portalPairs,l=e.getContext();e.autoClear=!1,t.matrixAutoUpdate=!1,o.forEach(function(o){o.forEach(function(c,a){var h=o[1-a],d=new THREE.Scene;d.children=c.children,l.colorMask(!1,!1,!1,!1),l.depthMask(!1),l.disable(l.DEPTH_TEST),l.enable(l.STENCIL_TEST),l.stencilFunc(l.NOTEQUAL,i,255),l.stencilOp(l.INCR,l.KEEP,l.KEEP),l.stencilMask(255),e.render(d,t);var E=(new THREE.PerspectiveCamera).copy(t);if(E.matrixWorld=function(e,t,i){var n=e.matrixWorld.clone();n.invert().multiply(t.matrixWorld);var r=i.matrixWorld.clone().invert(),s=(new THREE.Matrix4).makeRotationY(Math.PI);return(new THREE.Matrix4).multiply(n).multiply(s).multiply(r).invert()}(t,c,h),E.projectionMatrix=function(e,t,i){var n=t.clone().invert(),r=(new THREE.Matrix4).extractRotation(e.matrixWorld),s=(new THREE.Vector3).set(0,0,1).applyMatrix4(r),o=new THREE.Plane;o.setFromNormalAndCoplanarPoint(s,e.getWorldPosition(new THREE.Vector3)),o.applyMatrix4(n);var l=new THREE.Vector4;l.set(o.normal.x,o.normal.y,o.normal.z,o.constant);var c=i.clone(),a=new THREE.Vector4;return a.x=(Math.sign(l.x)+c.elements[8])/c.elements[0],a.y=(Math.sign(l.y)+c.elements[9])/c.elements[5],a.z=-1,a.w=(1+c.elements[10])/i.elements[14],l.multiplyScalar(2/l.dot(a)),c.elements[2]=l.x,c.elements[6]=l.y,c.elements[10]=l.z+1,c.elements[14]=l.w,c}(h,E.matrixWorld,E.projectionMatrix),i==n.data.maxRecursion){l.colorMask(!0,!0,!0,!0),l.depthMask(!0),e.clear(!1,!0,!1),l.enable(l.DEPTH_TEST),l.enable(l.STENCIL_TEST),l.stencilMask(0),l.stencilFunc(l.EQUAL,i+1,255),(new THREE.Scene).children=r.object3D.children.filter(function(e){return!s.includes(e)});var b=new THREE.Scene;b.children=r.object3D.children,e.render(b,E)}else n.renderRecursivePortals(e,E,i+1);l.colorMask(!1,!1,!1,!1),l.depthMask(!1),l.enable(l.STENCIL_TEST),l.stencilMask(255),l.stencilFunc(l.NOTEQUAL,i+1,255),l.stencilOp(l.DECR,l.KEEP,l.KEEP),e.render(d,t)})}),l.disable(l.STENCIL_TEST),l.stencilMask(0),l.colorMask(!1,!1,!1,!1),l.enable(l.DEPTH_TEST),l.depthMask(!0),l.depthFunc(l.ALWAYS),e.clear(!1,!0,!1),s.forEach(function(i){var n=new THREE.Scene;n.children=i.children,e.render(n,t)}),l.depthFunc(l.LESS),l.enable(l.STENCIL_TEST),l.stencilMask(0),l.stencilFunc(l.LEQUAL,i,255),l.colorMask(!0,!0,!0,!0),l.depthMask(!0),(new THREE.Scene).children=r.object3D.children;var c=new THREE.Scene;c.children=r.object3D.children,e.render(c,t),t.matrixAutoUpdate=!0}})});
//# sourceMappingURL=aframe-portals.umd.js.map
